#ifndef __BREAK_EVEN_MANAGER_MQH__
#define __BREAK_EVEN_MANAGER_MQH__

#include <Trade/Trade.mqh>

//--------------------------------------------------
// External trade object (defined in TradeExecutor)
//--------------------------------------------------
extern CTrade Trade;

//--------------------------------------------------
// Move SL to break-even using ATR (MQL5-correct)
//--------------------------------------------------
void ManageBreakEven(
   const string sym,
   int atrPeriod,
   double atrTrigger,
   double atrBuffer
)
{
   if(!PositionSelect(sym))
      return;

   int    type  = (int)PositionGetInteger(POSITION_TYPE);
   double entry = PositionGetDouble(POSITION_PRICE_OPEN);
   double sl    = PositionGetDouble(POSITION_SL);
   double tp    = PositionGetDouble(POSITION_TP);

   double price = 0.0;
   if(type == POSITION_TYPE_BUY)
      price = SymbolInfoDouble(sym, SYMBOL_BID);
   else
      price = SymbolInfoDouble(sym, SYMBOL_ASK);

   // --------------------------------------------------
   // ATR HANDLE (MQL5 style)
   // --------------------------------------------------
   int atrHandle = iATR(sym, PERIOD_M1, atrPeriod);
   if(atrHandle == INVALID_HANDLE)
      return;

   double atrBuf[];
   if(CopyBuffer(atrHandle, 0, 0, 1, atrBuf) <= 0)
   {
      IndicatorRelease(atrHandle);
      return;
   }

   IndicatorRelease(atrHandle);

   double atr = atrBuf[0];
   if(atr <= 0.0)
      return;

   // Has price moved far enough?
   if(MathAbs(price - entry) < atr * atrTrigger)
      return;

   double newSL = entry;

   // Apply buffer
   if(type == POSITION_TYPE_BUY)
      newSL = entry + atr * atrBuffer;
   else
      newSL = entry - atr * atrBuffer;

   // Only move SL forward
   if(type == POSITION_TYPE_BUY && newSL <= sl)
      return;
   if(type == POSITION_TYPE_SELL && newSL >= sl)
      return;

   Trade.PositionModify(sym, newSL, tp);
}

#endif // __BREAK_EVEN_MANAGER_MQH__
